<!-- listarMermas.html -->
{% extends 'layout.html' %}
{% block content %}
{% from "_macros.html" import render_field, render_errors %}

<style>
    .form-group.col-md-3 {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
    }

    .form-group.col-md-3 label {
        margin-bottom: 0.5rem;
    }
</style>
<div class="row">
    <div class="col-md-6">
        <h1 class="h3 mb-2 text-gray"><i class="fas fa-times-circle"></i> Mermas</h1>
    </div>
</div>
<div class="card shadow mb-4" id="spacesTable">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold">Datos de merma</h6>
    </div>
    <div class="card-body">
        <form action="{{ url_for('mermas.modulo_mermas') }}" method="post">
            <div class="row mb-3">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <div class="form-group col-md-3"></div>
                <div class="form-group col-md-4">
                    {{ formTipo.tipo_merma.label(class="form-label") }}
                    {{ render_field(formTipo.tipo_merma, class="form-control", placeholder="Tipo de Merma") }}
                </div>
                <div class="form-group col-md-3">
                    <label for="materia_prima_id">Filtro</label>
                    <button type="submit" class="btn btn-success">Cambiar Merma</button>
                </div>
            </div>
        </form>
    <hr>
        <form action="/mermas/agregarMerma" method="POST" class="mt-3">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <div class="row mb-3">
                {{ render_field(form.id, class="form-control", placeholder="Tipo de Merma") }}
                <div class="form-group col-md-3">
                    {% if form.tipo_merma.data == 'materiaPrima' %}
                        <input type="hidden" id="materia_prima_id" name="materia_prima_id" value="{{ form.materia_prima_id.data }}">
                        <label for="materia_prima_id">Seleccionar materia</label>
                        <button type="button" class="btn btn-primary mt-3" data-toggle="modal" data-target="#materiaPrimaModal">
                            Seleccionar Materia Prima
                        </button>
                        {{  render_errors(form.materia_prima_id) }}
                    {% endif %}
                    {% if form.tipo_merma.data == 'galletas' %}
                        <input type="hidden" id="materia_prima_id" name="materia_prima_id" value="{{ form.materia_prima_id.data }}">
                        <label for="materia_prima_id">Seleccionar galleta</label>
                        <button type="button" class="btn btn-primary mt-3" data-toggle="modal" data-target="#galletaModal">
                            Seleccionar Galleta
                        </button>
                        {{  render_errors(form.materia_prima_id) }}
                    {% endif %}
                </div>
                <div class="form-group col-md-3">
                    <label for="tipo">
                        {{ form.tipo.label }}
                    </label>
                    <input type="text" id="nombre" name="nombre" readonly required placeholder="Nombre" class="form-control mt-2" value="{{ form.nombre.data or '' }}">
                    {% if form.tipo_merma.data == "materiaPrima" %}
                    <input type="text" id="tipo" name="tipo" readonly required placeholder="Tipo de medida" class="form-control mt-2" value="{{ form.tipo.data or '' }}">
                    {% endif %}
                    {% if form.tipo_merma.data == "galletas" %}
                        <select type="text" id="tipo" name="tipo" required placeholder="Tipo de medida" class="form-control mt-2" value="{{ form.tipo.data or '' }}">
                            <option value="pz">
                                pz
                            </option>
                        </select>
                    {% endif %}
                    {{  render_errors(form.tipo) }}
                </div>
                <div class="form-group col-md-3">
                    <label for="cantidad">
                        {{ form.cantidad.label }}
                    </label>
                    <input type="text" id="cantidad" required name="cantidad" placeholder="Cantidad" class="form-control mt-2" value="{{ form.cantidad.data or '' }}">
                    {{  render_errors(form.cantidad) }}
                </div>
                <div class="form-group col-md-3">
                    <label for="cantidad">
                        {{ form.fecha.label }}
                    </label>
                    {{ render_field(form.fecha, class="form-control mt-2", type="datetime-local", placeholder="Fecha y Hora") }}
                </div>
            </div>
            <div class="row mb-3">
                <div class="form-group col-md-12">
                    {{ form.descripcion.label(class="form-label") }}
                    {{ render_field(form.descripcion, class="form-control", placeholder="Descripción") }}
                </div>
            </div>
            <div class="row mb-3" style="
                visibility: hidden;
                width: 0;
                height: 0;
                margin: 0;
                padding: 0;
            ">
            <div class="form-group col-md-12">
                    {{ render_field(form.tipo_merma, style="display: hidden;", class="form-control", placeholder="Descripción") }}
            </div>
            </div>
            <div class="col-md-12 text-center">
                {% if form.id.data == 0 %}
                    <button type="submit" class="btn btn-success">Guardar Merma</button>
                {% endif %}
                {% if form.id.data != 0 %}
                    <button type="submit" class="btn btn-success">Modificar Merma</button>
                {% endif %}
                </div>
        </form>
    </div>
</div>

<div class="card shadow mb-4" id="spacesTable">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold">Listado de mermas</h6>
    </div>
    <div class="card-body">
        <div class="scrollable-table" style="overflow: auto; max-height: 400px;">
            <table class="table">
                <thead>
                <tr class="text-center">
                    <th>ID</th>
                    <th>Materia Prima</th>
                    <th>Tipo</th>
                    <th>Cantidad</th>
                    <th>Descripción</th>
                    <th>Fecha</th>
                    <th>Acciones</th>
                </tr>
                </thead>
                <tbody>
                {% for merma in mermas %}
                    <tr class="text-center">
                        <td>{{ merma.id }}</td>
                        {% if form.tipo_merma.data == "materiaPrima" %}
                            <td>{{ merma.materia_prima.tipo_materia.nombre }}</td>
                        {% endif %}
                        {% if form.tipo_merma.data == "galletas" %}
                            <td>{{ merma.produccion.receta.nombre }}</td>
                        {% endif %}
                        <td>{{ merma.tipo }}</td>
                        <td>{{ merma.cantidad }}</td>
                        <td>{{ merma.descripcion }}</td>
                        <td>{{ merma.fecha.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                        <td>
                            <form action="{{ url_for('mermas.seleccionar_merma')}}" method="post" class="d-inline">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                <input type="hidden" name="id" value="{{ merma.id }}">
                                <input type="hidden" name="tipo_merma" value="{{ form.tipo_merma.data }}">
                                <button type="submit" class="btn btn-warning btn-sm">Editar</button>
                            </form>
                            <button type="button" data-id = "{{ merma.id }}"  data-tipo = "{{ form.tipo_merma.data }}" class="btn btn-danger btn-sm mt-1 eliminarMerma" data-toggle="modal" data-target="#modalConfirmacion">Eliminar</button>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="materiaPrimaModal" tabindex="-1" aria-labelledby="materiaPrimaModalLabel" aria-hidden="true" role="dialog">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="materiaPrimaModalLabel">Seleccionar Materia Prima</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <table class="table">
          <thead>
            <tr>
                <th>Nombre</th>
                <th>Cantidad Disponible</th>
                <th>Tipo</th>
                <th>lote</th>
              <th>Seleccionar</th>
            </tr>
          </thead>
          <tbody>
            {% for materia in materiasPrimas %}
            <tr>
                <td>{{ materia.tipo_materia.nombre }}</td>
                <td>{{ materia.tipo }}</td>
                <td>{{ materia.cantidad_disponible }}</td>
                <td>{{ materia.lote }}</td>
              <td>
                <button type="button" class="btn btn-success select-materia" data-id="{{ materia.id }}"
                        data-tipo="{{ materia.tipo }}"
                        data-cantidad-disponible="{{ materia.cantidad_disponible }}" data-nombre="{{ materia.tipo_materia.nombre }}" data-bs-dismiss="modal">
                  Seleccionar
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>


    <!-- Modal -->
<div class="modal fade" id="galletaModal" tabindex="-1" aria-labelledby="galletaModalLabel" aria-hidden="true" role="dialog">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="galletaModalLabel">Seleccionar Galleta</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <table class="table">
          <thead>
            <tr>
                <th>Nombre</th>
                <th>Cantidad Disponible</th>
                <th>Lote</th>

              <th>Seleccionar</th>
            </tr>
          </thead>
          <tbody>
            {% for receta in recetas %}
            <tr>
                <td>{{receta.receta.nombre }}</td>
                <td>{{ receta.galletas_disponibles }}</td>
                                <td>{{ receta.lote }}</td>

              <td>
                <button type="button" class="btn btn-success select-galleta" data-id="{{ receta.id }}"
                        data-cantidad-disponible="{{ receta.galletas_disponibles }}"  data-nombre="{{ receta.receta.nombre }}" data-bs-dismiss="modal">
                  Seleccionar
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="modalConfirmacion" tabindex="-1" aria-labelledby="modalConfirmacion" aria-hidden="true" role="dialog">
   <div class="container mt-5 modal-dialog" role="document">
      <div class="row modal-content" style="display: contents;">
           <div class="col-md-12 offset-md-3 mx-0">
              <div class="card">
                <div class="card-body">
                  <h1 class="card-title text-center">Confirmar Borrado de Merma</h1>
                  <p class="card-text text-center">Estás a punto de eliminar la merma</p>
                  <div class="text-center">
                      <form action="{{ url_for('mermas.eliminar_merma')}}" method="post" class="d-inline">
                         <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                         <input type="hidden" name="id" id="idEliminar">
                          <input type="hidden" name="tipoMerma" id="tipoMerma">

                         <button type="submit" class="btn btn-danger">Eliminar</button>
                      </form>
                      <button type="button" id="closeModalConfirmacion" class="closeModalConfirmacion btn btn-success">
                         Cancelar
                      </button>
                  </div>
                </div>
              </div>
            </div>
       </div>
   </div>
</div>



<script src="{{ url_for('static', filename='jquery/jquery.min.js') }}"></script>


<script>
$(document).ready(function() {
  $('.select-materia').click(function() {
    var materiaPrimaId = $(this).data('id');
    var tipo = $(this).data('tipo');
    var cantidadDisponible = $(this).data('cantidad-disponible');
    var nombre = $(this).data('nombre');
    $('#materia_prima_id').val(materiaPrimaId);
    $('#tipo').val(tipo);
    $('#nombre').val(nombre);
    $('#cantidad').val(cantidadDisponible);
    $('#materiaPrimaModal').modal('hide')
  });


    $('.select-galleta').click(function() {
    var materiaPrimaId = $(this).data('id');
    var cantidadDisponible = $(this).data('cantidad-disponible');
    var nombre = $(this).data('nombre');

    $('#materia_prima_id').val(materiaPrimaId);
    $('#nombre').val(nombre);
    $('#cantidad').val(cantidadDisponible);
    $('#galletaModal').modal('hide')
  });

  $('.eliminarMerma').click(function() {
    var mermaId = $(this).data('id');
    var tipo = $(this).data('tipo');

    $('#idEliminar').val(mermaId);
    $('#tipoMerma').val(tipo);

  });
  $('#closeModalConfirmacion').click(function() {
      $('#modalConfirmacion').modal('hide')
  });
});
</script>
{% endblock %}
